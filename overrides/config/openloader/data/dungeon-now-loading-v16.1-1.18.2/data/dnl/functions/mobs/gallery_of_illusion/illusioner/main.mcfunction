execute at @s as @e[tag=noai] run data merge entity @s {NoAI:0b}
tag @e[tag=noai] remove noai
execute as @s store result score @s dnl.health run data get entity @s Health 1

## phase 1 ##
execute at @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint1] run summon zombie ~ ~ ~ {Glowing:1b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/1",PersistenceRequired:1b,Health:24f,Tags:["illusioned_gallery","order1"],CustomName:'{"text":"V","color":"green","italic":false}',ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;-1489871403,98255662,-1195015907,812404133],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMzBjNDg3M2U0YTIxOTE0NWViNGUzZjY2YzA5ZTJjZThiMjdkZTJmZDgxZGViNDhlM2M3ZTA0ZTk3NGU1ZWFhIn19fQ=="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:24}]}
execute at @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint2] run summon skeleton ~ ~ ~ {Invulnerable:1b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/2",PersistenceRequired:1b,Health:24f,Tags:["illusioned_gallery","order2"],HandItems:[{id:"minecraft:bow",Count:1b,tag:{Enchantments:[{id:"minecraft:power",lvl:1s},{id:"minecraft:flame",lvl:1s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;391903545,-639941351,-1417088675,396922584],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvYTM1ZjhmNTZlMWEyMzNmY2Q5Nzc3Mjg1ZTRiNWFiMTNmYWEwYzZkODJmYTYzNTQyNWMxNzQ1ZDQxMWU4NTcxZCJ9fX0="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:24}]}
execute at @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint3] run summon stray ~ ~ ~ {Invulnerable:1b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/3",PersistenceRequired:1b,Health:24f,Tags:["illusioned_gallery","order3"],HandItems:[{id:"minecraft:bow",Count:1b,tag:{Enchantments:[{id:"minecraft:power",lvl:1s},{id:"minecraft:punch",lvl:1s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;-2118612348,-1748679260,-1269210549,-645524326],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMTQ0NjM1ZDZiYjhmOWFhNDZkYjYwODc1YmI1ZGIzOTQwYWIwYzRmMGViNjg0YzZiODg4NjQ3YmIzMzkyN2UifX19"}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:24}]}
execute at @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint4] run summon drowned ~ ~ ~ {Invulnerable:1b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/4",PersistenceRequired:1b,Health:24f,Tags:["illusioned_gallery","order4"],HandItems:[{id:"minecraft:trident",Count:1b,tag:{Enchantments:[{id:"minecraft:impaling",lvl:1s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;293962926,685919481,-1818534130,-1558039932],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMjlhOWYzZDc5YTJkOGRiOGQ2NmI1OTc1MjU0MmFkNmUxMzQ5ODUzMjU4ZmFkOTg0ODc4OTI3NzM2YmQ1YjkxIn19fQ=="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:24}]}

data merge entity @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] {Invulnerable:1b,Glowing:0b}
tag @s[tag=!phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..200}] add phase1

## phase 2 ##
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint2] run summon vindicator ~ ~ ~ {Glowing:1b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/1",PersistenceRequired:1b,Health:31f,Tags:["illusioned_gallery","order1"],HandItems:[{id:"minecraft:iron_axe",Count:1b,tag:{Enchantments:[{id:"minecraft:sharpness",lvl:3s},{id:"minecraft:efficiency",lvl:3s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;-1489871403,98255662,-1195015907,812404133],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMzBjNDg3M2U0YTIxOTE0NWViNGUzZjY2YzA5ZTJjZThiMjdkZTJmZDgxZGViNDhlM2M3ZTA0ZTk3NGU1ZWFhIn19fQ=="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:31}]}
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint1] run summon pillager ~ ~ ~ {Invulnerable:1b,Glowing:0b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/2",PersistenceRequired:1b,Health:31f,Tags:["illusioned_gallery","order2"],HandItems:[{id:"minecraft:crossbow",Count:1b,tag:{Enchantments:[{id:"minecraft:multishot",lvl:1s},{id:"minecraft:quick_charge",lvl:3s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;391903545,-639941351,-1417088675,396922584],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvYTM1ZjhmNTZlMWEyMzNmY2Q5Nzc3Mjg1ZTRiNWFiMTNmYWEwYzZkODJmYTYzNTQyNWMxNzQ1ZDQxMWU4NTcxZCJ9fX0="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:31}]}
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint3] run summon zombie_villager ~ ~ ~ {Invulnerable:1b,Glowing:0b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/3",PersistenceRequired:1b,Health:35f,Tags:["illusioned_gallery","order3"],HandItems:[{id:"minecraft:iron_pickaxe",Count:1b,tag:{Enchantments:[{id:"minecraft:sharpness",lvl:4s},{id:"minecraft:looting",lvl:2s},{id:"minecraft:efficiency",lvl:2s}]}},{}],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;-2118612348,-1748679260,-1269210549,-645524326],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMTQ0NjM1ZDZiYjhmOWFhNDZkYjYwODc1YmI1ZGIzOTQwYWIwYzRmMGViNjg0YzZiODg4NjQ3YmIzMzkyN2UifX19"}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:35}],VillagerData:{profession:"minecraft:weaponsmith",type:"minecraft:snow"}}
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] at @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint4] run summon evoker ~ ~ ~ {Invulnerable:1b,Glowing:0b,DeathLootTable:"dnl:structures/gallery_of_illusion/mobs/order/4",PersistenceRequired:1b,Health:40f,Tags:["illusioned_gallery","order4"],ArmorItems:[{},{},{},{id:"minecraft:player_head",Count:1b,tag:{SkullOwner:{Id:[I;293962926,685919481,-1818534130,-1558039932],Properties:{textures:[{Value:"eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3JhZnQubmV0L3RleHR1cmUvMjlhOWYzZDc5YTJkOGRiOGQ2NmI1OTc1MjU0MmFkNmUxMzQ5ODUzMjU4ZmFkOTg0ODc4OTI3NzM2YmQ1YjkxIn19fQ=="}]}}}}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],Attributes:[{Name:generic.max_health,Base:40}]}

data merge entity @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] {Invulnerable:1b,Glowing:0b}
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] run kill @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint1]
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] run kill @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint2]
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] run kill @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint3]
execute at @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] run kill @e[type=minecraft:area_effect_cloud,sort=nearest,limit=1,tag=spawnpoint4]
tag @s[tag=phase1,tag=!phase2,tag=!phase3,scores={dnl.health=..100}] add phase2

## order ##
execute at @e[type=item,nbt={Item:{tag:{Tags:["order1_killed"]}}}] run data merge entity @e[tag=order2,sort=nearest,limit=1] {Invulnerable:0b,Glowing:1b}
execute at @e[type=item,nbt={Item:{tag:{Tags:["order2_killed"]}}}] run data merge entity @e[tag=order3,sort=nearest,limit=1] {Invulnerable:0b,Glowing:1b}
execute at @e[type=item,nbt={Item:{tag:{Tags:["order3_killed"]}}}] run data merge entity @e[tag=order4,sort=nearest,limit=1] {Invulnerable:0b,Glowing:1b}
execute at @e[type=item,nbt={Item:{tag:{Tags:["order4_killed"]}}}] run data merge entity @e[type=illusioner,tag=illusioned_gallery,tag=boss,sort=nearest,limit=1] {Invulnerable:0b,Glowing:1b}

kill @e[type=item,nbt={Item:{tag:{Tags:["order1_killed"]}}}]
kill @e[type=item,nbt={Item:{tag:{Tags:["order2_killed"]}}}]
kill @e[type=item,nbt={Item:{tag:{Tags:["order3_killed"]}}}]
kill @e[type=item,nbt={Item:{tag:{Tags:["order4_killed"]}}}]

## phase 3 ##
tag @s[tag=phase1,tag=phase2,tag=!phase3,scores={dnl.health=..50}] add phase3
scoreboard players add @s[tag=phase1,tag=phase2,tag=phase3] dnl.variable 1
execute at @s[tag=phase1,tag=phase2,tag=phase3,scores={dnl.variable=30..}] if entity @a[distance=..8] run summon skeleton ~ ~ ~ {Silent:1b,Health:1f,HandItems:[{id:"minecraft:golden_hoe",Count:1b,tag:{Enchantments:[{id:"minecraft:sharpness",lvl:5s}]}},{}],HandDropChances:[0.000F,0.085F],ArmorItems:[{},{},{},{id:"minecraft:jack_o_lantern",Count:1b}],ArmorDropChances:[0.085F,0.085F,0.085F,0.000F],ActiveEffects:[{Id:1b,Amplifier:2b,Duration:20000000},{Id:14b,Amplifier:0b,Duration:20000000}],Attributes:[{Name:generic.max_health,Base:1}]}
execute at @s[tag=phase1,tag=phase2,tag=phase3,scores={dnl.variable=30..}] if entity @a[distance=..8] run particle minecraft:cloud ~ ~ ~ 0.5 1 0.5 0.0000001 30
scoreboard players reset @s[tag=phase1,tag=phase2,tag=phase3,scores={dnl.variable=30..}] dnl.variable
